<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Admin Dashboard</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin Specific Overrides */
        .admin-controls {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            background: #ffb74d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-save {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .input-mini {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" style="background: #fff3e0;">
            <div class="logo">
                <h2 style="color: #e65100;">Canteen Admin</h2>
            </div>
            <nav>
                <ul>
                    <li class="active" onclick="switchSection('menu')"><i class="fas fa-utensils"></i> Manage Menu</li>
                    <li onclick="switchSection('verify')"><i class="fas fa-search"></i> Check Order ID</li>
                    <li onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="page-title" id="pageTitle">Menu Management</div>
                <div class="user-menu">
                    <div style="font-weight: bold; color: #e65100;">Welcome, Admin</div>
                </div>
            </header>

            <!-- Sections -->
            <!-- SECTION 1: MENU MANAGEMENT -->
            <div id="menu-section" class="section active-section">

                <div
                    style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
                    <div class="section-header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2><i class="fas fa-calendar-alt"></i> Manage Daily Menu</h2>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button class="btn-save" style="background:#4caf50; margin-right:10px;"
                                onclick="openAddModal()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                            <label>For Date:</label>
                            <input type="date" id="menuDateInput" class="form-input"
                                style="padding:10px; border:1px solid #ddd; border-radius:5px;">
                            <button class="btn-save" onclick="loadMenuForDate()"
                                style="background:#2196f3; margin:0;"><i class="fas fa-sync"></i> Load</button>
                        </div>
                    </div>

                    <div id="menuEditorContainer" style="display:none;">
                        <div
                            style="margin-bottom:20px; padding:15px; background:#e3f2fd; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                            <span><i class="fas fa-info-circle"></i> Set prices & stock for this date. (Changes replace
                                defaults)</span>
                        </div>

                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Date Price (â‚¹)</th>
                                    <th>Quantity (Plates)</th>
                                </tr>
                            </thead>
                            <tbody id="menuTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>

                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn-save" onclick="publishMenu()"
                                style="background: #e65100; font-size: 1.1rem; padding: 10px 30px;">
                                <i class="fas fa-check-circle"></i> Publish for Selected Date
                            </button>
                        </div>
                    </div>
                    <div id="menuPlaceholder" style="text-align:center; padding:40px; color:#999;">
                        Please select a date and click 'Load' to manage the menu.
                    </div>
                </div>

            </div>

            <!-- SECTION 2: CHECK ID -->
            <div id="verify-section" class="section" style="display: none;">
                <div
                    style="max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #e65100; margin-bottom: 20px;"><i class="fas fa-search-dollar"></i> Verify Student
                        Order</h2>
                    <p style="color: #666; margin-bottom: 30px;">Enter the Order ID provided by the student (e.g.,
                        FOOD-1234).</p>

                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 30px;">
                        <input type="text" id="verifyInput" placeholder="Enter Order ID"
                            style="padding: 15px; font-size: 1.2rem; border: 2px solid #eee; border-radius: 10px; width: 60%; text-transform: uppercase;">
                        <button onclick="verifyOrder()"
                            style="padding: 15px 30px; font-size: 1.1rem; background: #e65100; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                            Check
                        </button>
                    </div>

                    <div id="verificationResult"
                        style="display: none; padding: 20px; border-radius: 10px; border: 2px dashed #ccc;">
                        <!-- JS injects here -->
                    </div>

                </div>
            </div>

            <!-- Global Footer -->
            <footer class="main-footer">
                &copy; 2026 Lendi Institute of Engineering and Technology. All Rights Reserved.
            </footer>
        </main>
    </div>

    <!-- LOGOUT CONFIRMATION MODAL -->
    <div id="logoutModal" class="logout-modal-overlay">
        <div class="logout-modal-box">
            <h3><i class="fas fa-sign-out-alt" style="color:#ff6b6b;"></i> Confirm Logout</h3>
            <p>Are you sure you want to end your session?</p>
            <div class="logout-actions">
                <button class="btn-stay" onclick="closeLogoutModal()">No, Stay</button>
                <button class="btn-confirm-logout" onclick="confirmLogout()">Yes, Logout</button>
            </div>
        </div>
    </div>

    <!-- ADD ITEM MODAL -->
    <div id="addItemModal" class="logout-modal-overlay" style="display:none;">
        <div class="logout-modal-box" style="text-align:left;">
            <h3><i class="fas fa-utensils"></i> Add New Master Item</h3>
            <p>This item will be available for all future dates.</p>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
                <label>Item Name:</label>
                <input type="text" id="newItemName" class="form-input" placeholder="e.g. Pizza">
                <label>Default Price (â‚¹):</label>
                <input type="number" id="newItemPrice" class="form-input" placeholder="e.g. 150">

            </div>
            <div class="logout-actions" style="margin-top:20px;">
                <button class="btn-stay" onclick="closeAddModal()">Cancel</button>
                <button class="btn-confirm-logout" style="background:#4caf50;" onclick="saveNewItem()">Save
                    Item</button>
            </div>
        </div>
    </div>

    <script>
        // Check Auth
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || user.role !== 'FOOD_ADMIN') {
            window.location.href = 'login.html';
        }

        function switchSection(sec) {
            document.querySelectorAll('aside li').forEach(l => l.classList.remove('active'));
            document.getElementById('menu-section').style.display = 'none';
            document.getElementById('verify-section').style.display = 'none';

            if (sec === 'menu') {
                document.getElementById('menu-section').style.display = 'block';
                document.getElementById('pageTitle').innerText = "Menu Management";
                document.querySelectorAll('aside li')[0].classList.add('active');
            } else {
                document.getElementById('verify-section').style.display = 'block';
                document.getElementById('pageTitle').innerText = "Check Order ID";
                document.querySelectorAll('aside li')[1].classList.add('active');
                document.getElementById('verificationResult').style.display = 'none';
                document.getElementById('verifyInput').value = '';
            }
        }

        function verifyOrder() {
            const id = document.getElementById('verifyInput').value.trim();
            if (!id) return alert("Please enter an Order ID");

            // Strip prefix if user typed it manually, though backend expects full id usually? 
            // My implementation generates "FOOD-1234". Let's assume input matches exactly or we can fix common issues.
            // Let's rely on backend check.

            const resultBox = document.getElementById('verificationResult');
            resultBox.style.display = 'block';
            resultBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            resultBox.className = '';

            fetch(`/api/food/verify/${id}`, { method: 'POST' })
                .then(res => {
                    if (res.status === 404) return { status: 'INVALID', message: 'Invalid Order ID' };
                    return res.json();
                })
                .then(data => {
                    let color = "red";
                    let icon = "times-circle";

                    if (data.status === 'SUCCESS') {
                        color = "green";
                        icon = "check-circle";
                    } else if (data.status === 'ALREADY_COMPLETED') {
                        color = "#f39c12"; // Orange
                        icon = "exclamation-triangle";
                    } else if (data.status === 'CANCELLED') {
                        color = "red";
                        icon = "ban";
                    }

                    resultBox.style.background = (data.status === 'SUCCESS') ? '#d4edda' : (data.status === 'ALREADY_COMPLETED' ? '#fff3cd' : (data.status === 'CANCELLED' ? '#ffcdd2' : '#f8d7da')); // Better Red background

                    resultBox.innerHTML = `
                    <div style="color: ${color}; font-size: 1.5rem; margin-bottom: 10px;">
                        <i class="fas fa-${icon}"></i> <strong>${data.message}</strong>
                    </div>
                    ${data.items ? `<div style="color: #333; font-size: 1rem;"><strong>Items:</strong> ${data.items}</div>` : ''}
                    ${data.studentId ? `<div style="color: #666; font-size: 0.9rem;">Student ID: ${data.studentId}</div>` : ''}
                `;
                })
                .catch(err => {
                    resultBox.innerHTML = `<span style="color:red">Error contacting server.</span>`;
                });
        }

        // Default Date to Tomorrow on Load (Strict Local Time)
        window.onload = function () {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const yyyy = tomorrow.getFullYear();
            const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const dd = String(tomorrow.getDate()).padStart(2, '0');
            document.getElementById('menuDateInput').value = `${yyyy}-${mm}-${dd}`;
            loadMenuForDate();
        };

        let currentMenuData = [];

        function loadMenuForDate() {
            const date = document.getElementById('menuDateInput').value;
            if (!date) { alert("Please select a date"); return; }

            fetch(`/api/food/daily-menu?date=${date}`, { method: 'GET' })
                .then(r => {
                    if (!r.ok) throw new Error("HTTP " + r.status + " " + r.statusText);
                    return r.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    if (!Array.isArray(data)) throw new Error("Invalid response format");

                    currentMenuData = data;
                    renderMenuEditor();
                })
                .catch(err => {
                    console.error(err);
                    alert("Error loading menu: " + err.message);
                });
        }

        function renderMenuEditor() {
            document.getElementById('menuPlaceholder').style.display = 'none';
            document.getElementById('menuEditorContainer').style.display = 'block';

            const tbody = document.getElementById('menuTable');
            tbody.innerHTML = '';

            if (currentMenuData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align:center; padding:30px; color:#666;">
                            <div style="font-size:1.2rem; margin-bottom:10px;"><i class="fas fa-calendar-times" style="color:#ff6b6b"></i> No Menu for this Date</div>
                            <p>Is the Canteen Open?</p>
                            <button onclick="initializeMenu()" style="background:#2ecc71; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; margin-right:10px;">
                                <i class="fas fa-check"></i> Open Canteen (Load Defaults)
                            </button>
                            <button onclick="markHoliday()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">
                                <i class="fas fa-bed"></i> Mark as Holiday
                            </button>
                        </td>
                    </tr>`;
                return;
            }

            currentMenuData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:1.5rem;">${item.icon}</span> 
                        <div>
                            <strong>${item.name}</strong> <br>
                            ${item.isPublished ? '<span style="color:green; font-size:0.8rem;"><i class="fas fa-check"></i> Live</span>' : '<span style="color:orange; font-size:0.8rem;">Draft</span>'}
                        </div>
                    </td>
                    <td>
                        <input type="number" class="input-mini" style="width:80px; padding:5px; border-radius:4px; border:1px solid #ddd;" 
                            value="${item.price}" id="price-${index}">
                    </td>
                    <td>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" class="input-mini" style="width:80px; padding:5px; border-radius:4px; border:1px solid #ddd;" 
                                value="${item.available}" id="qty-${index}">
                            
                            <!-- Actions -->
                            <button title="Apply Changes" onclick="publishMenu()" style="background:none; border:none; color:#3498db; cursor:pointer;">
                                <i class="fas fa-save"></i>
                            </button>
                            <button title="Remove from Today" onclick="deleteFromDaily(${item.dailyMenuId}, ${index})" style="background:none; border:none; color:#e74c3c; cursor:pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function initializeMenu() {
            const date = document.getElementById('menuDateInput').value;
            fetch('/api/food/daily-menu/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date })
            }).then(r => r.json())
                .then(d => {
                    if (d.error) alert(d.error);
                    else loadMenuForDate();
                });
        }

        function markHoliday() {
            alert("Date marked as Canteen Closed. Students will see 'Holiday'.");
            // No action needed really, empty menu = Holiday.
        }

        function deleteFromDaily(dailyId, index) {
            if (!dailyId) {
                // Not saved yet or just specific logic? For defaults loaded via init, they should have IDs if saved.
                // If init calls /init endpoint, they are saved.
                alert("Please Refresh Page first to get IDs"); return;
            }
            if (!confirm("Remove this item from TODAY'S menu?")) return;

            fetch(`/api/food/daily-menu/${dailyId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(d => {
                    loadMenuForDate();
                });
        }

        function publishMenu() {
            const date = document.getElementById('menuDateInput').value;
            if (!date) return;

            // Gather data
            const itemsFn = currentMenuData.map((item, index) => ({
                id: item.id,
                price: document.getElementById(`price-${index}`).value,
                available: document.getElementById(`qty-${index}`).value
            }));

            fetch('/api/food/daily-menu', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date, items: itemsFn })
            }).then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
                .then(data => {
                    if (data.error) alert("Error: " + data.error);
                    else {
                        alert(data.message);
                        loadMenuForDate(); // Refresh UI to show Live status
                    }
                })
                .catch(e => alert("Publish failed: " + e));
        }

        function logout() {
            document.getElementById('logoutModal').style.display = 'flex';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            localStorage.removeItem("user");
            window.location.href = "login.html";
        }

        // Add Item Logic
        function openAddModal() {
            document.getElementById('addItemModal').style.display = 'flex';
        }
        function closeAddModal() {
            document.getElementById('addItemModal').style.display = 'none';
        }
        function saveNewItem() {
            const name = document.getElementById('newItemName').value;
            const price = document.getElementById('newItemPrice').value;
            // Default random icons
            const icons = ['ðŸ²', 'ðŸ¥—', 'ðŸ›', 'ðŸœ', 'ðŸ', 'ðŸ±', 'ðŸ¥˜', 'ðŸ½ï¸'];
            const icon = icons[Math.floor(Math.random() * icons.length)];

            if (!name || !price) { alert("Please fill Name and Price"); return; }

            const payload = { name: name, defaultPrice: parseFloat(price), icon: icon };

            fetch('/api/food/master-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
                .then(saveRes => {
                    // Item added to Master (Hidden from defaults). Now Add to THIS Date explicitly.
                    const newId = saveRes.id;
                    const date = document.getElementById('menuDateInput').value;
                    const itemEntry = { id: newId, price: parseFloat(price), available: 50 }; // Default 50 plates

                    // Publish just this one item to correct date
                    fetch('/api/food/daily-menu', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date: date, items: [itemEntry] })
                    }).then(() => {
                        alert("Item Added & Published for " + date + " only!");
                        closeAddModal();
                        loadMenuForDate();
                    });
                })
                .catch(e => alert("Error: " + e));
        }

        // Initial Load


    </script>
</body>

</html>