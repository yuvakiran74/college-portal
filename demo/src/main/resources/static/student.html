<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>StudentPortal</h2>
            </div>
            <nav>
                <ul>
                    <li class="active" onclick="showSection('apply')"><i class="fas fa-edit"></i> Apply / Book</li>
                    <li onclick="showSection('info')"><i class="fas fa-info-circle"></i> Info</li>
                    <li onclick="showSection('attendance')"><i class="fas fa-map-marker-alt"></i> Attendance</li>
                    <li onclick="showSection('campusExplore')"><i class="fas fa-globe-americas"></i> Campus Explore</li>
                    <li onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="page-title">Dashboard</div>
                <div class="user-menu">
                    <div class="user-avatar-trigger" onclick="toggleMenu()" id="userAvatar">
                        <!-- JS will put initial here -->
                        U
                    </div>
                    <div class="dropdown" id="dropdown">
                        <div class="user-name" id="userNameDisplay">Student Name</div>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    </div>
                </div>
            </header>

            <!-- Sections -->
            <div id="content-area">

                <!-- APPLY SECTION WRAPPER -->
                <div id="apply" class="section active-section">
                    <!-- 1. Selection Container -->
                    <div id="applySelection" class="selection-container" style="padding-bottom: 60px;">
                        <h2>What would you like to do?</h2>
                        <!-- Fixed Grid Layout: 2 Columns -->
                        <div class="selection-grid"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; max-width: 700px; margin-left: auto; margin-right: auto;">

                            <!-- Leave Card -->
                            <div class="selection-card leave-card" onclick="openApplyForm('LEAVE')"
                                style="justify-self: center;">
                                <div class="icon-circle">
                                    <i class="fas fa-home"></i>
                                </div>
                                <h3>Apply Leave</h3>
                                <p>For one or multiple days off</p>
                            </div>

                            <!-- Outpass Card -->
                            <div class="selection-card outpass-card" onclick="openApplyForm('OUTPASS')"
                                style="justify-self: center;">
                                <div class="icon-circle">
                                    <i class="fas fa-walking"></i>
                                </div>
                                <h3>Apply Outpass</h3>
                                <p>Short duration (less than 24h)</p>
                            </div>

                            <!-- Food Book Card (Spans full width for centering) -->
                            <div class="selection-card"
                                style="grid-column: 1 / -1; justify-self: center; border-top: 4px solid #ff9966;"
                                onclick="openFoodMenu()">
                                <div class="icon-circle"
                                    style="background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <h3>Book Food</h3>
                                <p>Pre-order from Canteen</p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Form Container -->
                    <div id="applyFormContainer" class="apply-form-container">
                        <button class="back-btn" onclick="showSelection()">
                            <i class="fas fa-arrow-left"></i> Back to Selection
                        </button>

                        <div class="apply-header">
                            <h2 id="formTitle"><i class="fas fa-edit"></i> Apply</h2>
                            <p>Fill in the details below.</p>
                        </div>

                        <div class="form-card apply-card">
                            <form id="applyForm" onsubmit="submitForm(event)" autocomplete="off">
                                <input type="hidden" id="leaveTypeInput" name="leaveType">

                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" id="dateLabel">Start Date</label>
                                        <input type="date" name="startDate" class="form-control-enhanced" required>
                                    </div>
                                    <div class="col" id="daysGroup">
                                        <label class="form-label">Duration (Days)</label>
                                        <input type="number" name="days" class="form-control-enhanced" min="1"
                                            value="1">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Reason</label>
                                    <textarea name="reason" rows="4" class="form-control-enhanced" required
                                        placeholder="Please describe why you need this..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Supporting Document (Optional)</label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" name="file" class="form-control-enhanced">
                                    </div>
                                </div>

                                <div class="form-group" style="text-align: center;">
                                    <button type="submit" class="submit-btn-centered">
                                        <i class="fas fa-paper-plane"></i> Submit Application
                                    </button>
                                </div>
                            </form>
                            <p id="msg"></p>
                        </div>
                    </div>

                    <!-- 3. Food Menu Container (New) -->
                    <div id="foodMenuContainer" style="display: none; padding: 20px;">
                        <button class="back-btn" onclick="showSelection()">
                            <i class="fas fa-arrow-left"></i> Back to Selection
                        </button>
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-utensils" style="color: #ff9966;"></i> Canteen
                            Menu</h2>

                        <div class="food-grid" id="foodGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ATTENDANCE SECTION -->
                <div id="attendance" class="section">

                    <!-- 1. Attendance Selection Menu -->
                    <div id="attendanceSelection" class="selection-container">
                        <h2 style="text-align: center; margin-bottom: 30px; color: #333; font-weight: 700;">Attendance
                            Operations</h2>
                        <div class="selection-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; max-width: 900px; margin: 0 auto;">

                            <!-- Post Attendance Card -->
                            <div class="selection-card" onclick="showAttendanceSection('postAttendanceSection')"
                                style="border-top: 4px solid #ff4757;">
                                <div class="icon-circle"
                                    style="background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%);">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <h3>Post Attendance</h3>
                                <p>Verify location & mark present</p>
                            </div>

                            <!-- Day-wise Attendance Card -->
                            <div class="selection-card" onclick="showAttendanceSection('dayWiseSection')"
                                style="border-top: 44px solid #2ed573;">
                                <div class="icon-circle"
                                    style="background: linear-gradient(135deg, #2ed573 0%, #7bed9f 100%);">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <h3>Check Day-wise</h3>
                                <p>View daily status history</p>
                            </div>

                            <!-- Monthly Attendance Card -->
                            <div class="selection-card" onclick="showAttendanceSection('monthlySection')"
                                style="border-top: 4px solid #1e90ff;">
                                <div class="icon-circle"
                                    style="background: linear-gradient(135deg, #1e90ff 0%, #70a1ff 100%);">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h3>Monthly Report</h3>
                                <p>Check percentage & stats</p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Post Attendance Flow -->
                    <div id="postAttendanceSection" style="display: none; max-width: 600px; margin: 0 auto;">
                        <button class="back-btn" onclick="showAttendanceHome()">
                            <i class="fas fa-arrow-left"></i> Back to Menu
                        </button>

                        <div class="card-glass" style="text-align: center; position: relative; overflow: hidden;">
                            <h2 style="margin-bottom: 10px; color: #ff4757;"><i class="fas fa-satellite-dish"></i>
                                Location Verification</h2>
                            <p style="margin-bottom: 30px; color: #666;">You must be within the campus premises to post
                                attendance.</p>

                            <!-- Beautiful Analyze Button -->
                            <div class="analyze-btn-wrapper" onclick="analyseLocation()">
                                <div class="pulse-ring"></div>
                                <div class="pulse-ring delay"></div>
                                <div class="analyze-btn-inner">
                                    <i class="fas fa-search-location" id="analyzeIcon"></i>
                                </div>
                            </div>
                            <p style="margin-top: 20px; font-weight: 600; color: #4facfe;" id="analyzeText">Tap to
                                Analyze</p>

                            <div class="status-box" id="locationStatusBox" style="margin-top: 20px; display: none;">
                                <i class="fas fa-search-location" id="statusIcon"></i>
                                <p id="locationStatusText">Waiting...</p>
                            </div>

                            <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

                            <button class="btn-success-soft" id="postAttendanceBtn" onclick="postAttendance()" disabled
                                style="width: 100%; padding: 15px; opacity: 0.5; cursor: not-allowed; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2); transition: all 0.3s;">
                                <i class="fas fa-check-circle"></i> Post Attendance
                            </button>
                        </div>
                    </div>

                    <!-- 3. Day-wise View -->
                    <div id="dayWiseSection" style="display: none; max-width: 500px; margin: 0 auto;">
                        <button class="back-btn" onclick="showAttendanceHome()">
                            <i class="fas fa-arrow-left"></i> Back to Menu
                        </button>
                        <h2 style="margin-bottom: 20px; color: #2ed573; text-align: center;"><i
                                class="fas fa-calendar-alt"></i> Check Daily Status</h2>
                        <div class="card-glass">
                            <label class="form-label" style="text-align: center; display: block;">Select Date</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <input type="date" id="checkDateInput" class="form-control-enhanced">
                                <button onclick="checkDateAttendance()"
                                    style="background: #2ed573; color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Check
                                </button>
                            </div>

                            <div id="dateResultBox"
                                style="text-align: center; display: none; padding: 20px; background: #f9f9f9; border-radius: 12px; border: 1px dashed #ddd;">
                                <p style="color: #666; margin-bottom: 5px;">Status for <span id="resultDate"></span></p>
                                <h3 id="resultStatus" style="font-size: 1.8rem; margin: 0;">-</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. Monthly View -->
                <div id="monthlySection" style="display: none; max-width: 500px; margin: 0 auto;">
                    <button class="back-btn" onclick="showAttendanceHome()">
                        <i class="fas fa-arrow-left"></i> Back to Menu
                    </button>
                    <div class="card-glass" style="text-align: center;">
                        <h2 style="color: #1e90ff; margin-bottom: 30px;">Monthly Overview</h2>

                        <div style="position: relative; width: 150px; height: 150px; margin: 0 auto 30px;">
                            <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="#eee" stroke-width="3" />
                                <path id="circleProgress"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="#1e90ff" stroke-width="3" stroke-dasharray="0, 100" />
                            </svg>
                            <div
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold; color: #333;">
                                <span id="monthlyPercentDisplay">0%</span>
                            </div>
                        </div>

                        <p style="color: #777;">Your attendance for this month.</p>
                    </div>
                </div>

            </div>

            <!-- INFO SECTION -->
            <div id="info" class="section">
                <h2><i class="fas fa-info-circle" style="color: #4facfe;"></i> My Info</h2>

                <!-- Profile Details Block -->
                <div class="profile-details-card"
                    style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; align-items: center; gap: 20px;">
                    <div class="large-avatar"
                        style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                        <span id="profileAvatar">U</span>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: #333; font-size: 1.2rem;">Hello, <span
                                id="profileName">Student</span></h3>
                        <p style="margin: 5px 0 0; color: #777;">Student ID: <strong id="profileId"
                                style="color: #4facfe;">-</strong></p>
                    </div>
                </div>

                <div class="status-summary">
                    <div class="status-card card-pending">
                        <h3>Pending</h3>
                        <p id="pendingCount">0</p>
                        <i class="fas fa-clock"
                            style="position:absolute; right:20px; bottom:20px; opacity:0.3; font-size:3rem;"></i>
                    </div>
                    <div class="status-card card-approved">
                        <h3>Approved</h3>
                        <p id="approvedCount">0</p>
                        <i class="fas fa-check-circle"
                            style="position:absolute; right:20px; bottom:20px; opacity:0.3; font-size:3rem;"></i>
                    </div>
                    <div class="status-card card-rejected">
                        <h3>Rejected</h3>
                        <p id="rejectedCount">0</p>
                        <i class="fas fa-times-circle"
                            style="position:absolute; right:20px; bottom:20px; opacity:0.3; font-size:3rem;"></i>
                    </div>
                </div>

                <h3>Application History</h3>
                <div class="info-table-wrapper">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="leaveTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- NEW: Food Orders History -->
                <h3 style="margin-top: 40px; color: #ff9966;"><i class="fas fa-utensils"></i> My Food Orders</h3>
                <div class="info-table-wrapper">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="foodTable">
                            <tr>
                                <td colspan="5" style="text-align:center; color:#999;">No orders yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- CAMPUS EXPLORE SECTION -->
            <div id="campusExplore" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-globe-americas" style="color: #00cec9;"></i> Campus Explore</h2>
                    <div class="filter-group">
                        <select id="campusFilter" onchange="filterCampusPosts()"
                            style="padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none;">
                            <option value="ALL">All Updates</option>
                            <option value="EVENT">Events</option>
                            <option value="HOLIDAY">Holidays</option>
                            <option value="EXAM">Exams</option>
                            <option value="INFO">Info</option>
                        </select>
                    </div>
                </div>

                <div id="campusPostsGrid" style="display: grid; gap: 20px;">
                    <!-- Posts will be injected here -->
                </div>
            </div>

            <!-- SETTINGS SECTION -->
            <div id="settings" class="section">
                <h2>Settings</h2>
                <p>Profile settings functionality coming soon...</p>
            </div>

            <!-- Global Footer -->
            <footer class="main-footer">
                &copy; 2026 Lendi Institute of Engineering and Technology. All Rights Reserved.
            </footer>
        </main>
    </div>

    <!-- Order Summary Bar (Hidden by default) -->
    <div id="orderSummary" class="order-summary-bar" style="display: none;">
        <div>
            <span style="font-size: 0.9rem; opacity: 0.8;">Total</span>
            <div style="font-size: 1.2rem; font-weight: bold;">â‚¹<span id="orderTotal">0</span></div>
        </div>
        <button class="btn-clean"
            style="background: white; color: #333; padding: 5px 15px; border-radius: 20px; font-weight: bold; border: none; cursor: pointer;"
            onclick="placeOrder()">
            Reserve Now <i class="fas fa-check"></i>
        </button>
    </div>

    <script>
        // Initial Setup
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || user.role !== 'STUDENT') {
            window.location.href = 'login.html';
        }

        // Top Bar Display
        document.getElementById("userNameDisplay").innerText = user.name || "Student";
        const initial = (user.name || "S").charAt(0).toUpperCase();
        document.getElementById("userAvatar").innerText = initial;

        // Profile Section Display
        document.getElementById("profileName").innerText = user.name || "Student Name";
        document.getElementById("profileId").innerText = user.userId || "ID Not Found";
        document.getElementById("profileAvatar").innerText = initial;

        // Default load
        loadLeaves();
        loadFoodOrders();
        loadCampusPosts();

        // -----------------------
        // CAMPUS EXPLORE LOGIC
        // -----------------------
        let allCampusPosts = [];

        function loadCampusPosts() {
            console.log("Fetching campus posts...");
            fetch("/campus/all")
                .then(res => res.json())
                .then(data => {
                    console.log("Posts fetched:", data);
                    allCampusPosts = data;
                    renderCampusPosts('ALL');
                })
                .catch(err => {
                    console.error("Error loading posts:", err);
                });
        }

        function filterCampusPosts() {
            const category = document.getElementById('campusFilter').value;
            renderCampusPosts(category);
        }

        function renderCampusPosts(category) {
            const grid = document.getElementById('campusPostsGrid');
            const filtered = category === 'ALL' ? allCampusPosts : allCampusPosts.filter(p => p.category === category);

            if (filtered.length === 0) {
                grid.innerHTML = `<div style="text-align: center; color: #888; padding: 40px;">No updates found in this category.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(post => {
                let badgeColor = '#6c5ce7';
                let icon = 'fas fa-bullhorn';

                if (post.category === 'EVENT') { badgeColor = '#e17055'; icon = 'fas fa-calendar-alt'; }
                if (post.category === 'HOLIDAY') { badgeColor = '#00b894'; icon = 'fas fa-umbrella-beach'; }
                if (post.category === 'EXAM') { badgeColor = '#d63031'; icon = 'fas fa-book-open'; }

                return `
                <div class="post-card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid ${badgeColor}; animation: fadeIn 0.5s ease;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <span style="background: ${badgeColor}15; color: ${badgeColor}; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                            <i class="${icon}"></i> ${post.category}
                        </span>
                        <span style="color: #999; font-size: 0.85rem;"><i class="far fa-clock"></i> ${post.date}</span>
                    </div>
                    <h3 style="margin: 0 0 10px 0; color: #2d3436; font-size: 1.3rem;">${post.title}</h3>
                    <p style="color: #636e72; line-height: 1.6; margin: 0;">${post.content}</p>
                    <div style="margin-top: 15px; font-size: 0.8rem; color: #b2bec3; text-align: right;">
                        Posted by <strong>${post.facultyName || 'Faculty'}</strong>
                    </div>
                </div>
                `;
            }).join('');
        }

        // -----------------------
        // NAVIGATION
        // -----------------------
        function showSelection() {
            document.getElementById('applyFormContainer').style.display = 'none';
            document.getElementById('foodMenuContainer').style.display = 'none';
            document.getElementById('applySelection').style.display = 'block'; // Show cards
            document.getElementById('orderSummary').style.display = 'none';   // Hide cart

            document.getElementById("msg").innerText = "";
        }

        function showSection(sectionId) {
            // Update Sidebar UI
            document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Show Section
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active-section'));
            document.getElementById(sectionId).classList.add('active-section');

            // If clicking apply, reset to selection view
            if (sectionId === 'apply') {
                showSelection();
            }
        }

        function toggleMenu() {
            const dropdown = document.getElementById('dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function logout() {
            localStorage.removeItem("user");
            window.location.href = "login.html";
        }

        // Close dropdown on outside click
        window.onclick = function (event) {
            if (!event.target.closest('.user-menu')) {
                document.getElementById('dropdown').style.display = 'none';
            }
        }


        // -----------------------
        // LEAVE / OUTPASS LOGIC
        // -----------------------
        function openApplyForm(type) {
            document.getElementById('applySelection').style.display = 'none';
            document.getElementById('applyFormContainer').style.display = 'block';

            document.getElementById('leaveTypeInput').value = type;

            const title = document.getElementById('formTitle');
            const daysGroup = document.getElementById('daysGroup');
            const dateLabel = document.getElementById('dateLabel');

            if (type === 'LEAVE') {
                title.innerHTML = '<i class="fas fa-home" style="color: #e91e63;"></i> Apply For Leave';
                daysGroup.style.display = 'block';
                dateLabel.innerText = "Start Date";
            } else {
                title.innerHTML = '<i class="fas fa-walking" style="color: #673ab7;"></i> Apply For Outpass';
                daysGroup.style.display = 'none';
                dateLabel.innerText = "Date";
            }
        }

        function submitForm(e) {
            e.preventDefault();
            const form = document.getElementById('applyForm');
            const formData = new FormData(form);

            formData.append('studentName', user.name);
            formData.append('studentId', user.userId);

            fetch("/leave/apply", {
                method: "POST",
                body: formData
            })
                .then(async res => {
                    const msg = await res.text();
                    if (!res.ok) throw new Error(msg);
                    return msg;
                })
                .then(msg => {
                    document.getElementById("msg").innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
                    document.getElementById("msg").style.color = "green";
                    form.reset();
                    loadLeaves();
                    setTimeout(() => showSection('info'), 1500);
                })
                .catch(err => {
                    document.getElementById("msg").innerText = err.message;
                    document.getElementById("msg").style.color = "red";
                });
        }

        function loadLeaves() {
            fetch(`/leave/student-id/${user.userId}`)
                .then(res => res.json())
                .then(data => {
                    let rows = "";
                    let pending = 0, approved = 0, rejected = 0;

                    data.forEach(l => {
                        if (l.status === 'PENDING') pending++;
                        if (l.status === 'APPROVED') approved++;
                        if (l.status === 'REJECTED') rejected++;

                        let actionBtn = "-";
                        if (l.status === 'APPROVED') {
                            const btnText = l.leaveType === 'LEAVE' ? 'Leave Letter' : 'Outpass';
                            const dataStr = encodeURIComponent(JSON.stringify(l));
                            actionBtn = `<button class="btn-download" onclick="downloadLetter('${dataStr}')">
                                <i class="fas fa-download"></i> ${btnText}
                            </button>`;
                        }

                        rows += `<tr>
                        <td>${l.leaveType || '-'}</td>
                        <td>${l.startDate || '-'}</td>
                        <td>${l.reason}</td>
                        <td><span class="status-badge status-${l.status.toLowerCase()}">${l.status}</span></td>
                        <td>${actionBtn}</td>
                    </tr>`;
                    });
                    document.getElementById("leaveTable").innerHTML = rows;
                    document.getElementById("pendingCount").innerText = pending;
                    document.getElementById("approvedCount").innerText = approved;
                    document.getElementById("rejectedCount").innerText = rejected;
                });
        }

        function downloadLetter(dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            const uniqueId = `LENDI-${data.leaveType}-${data.id}`;
            const today = new Date().toLocaleDateString();

            let title, bodyContent;

            if (data.leaveType === 'LEAVE') {
                title = "OFFICIAL LEAVE LETTER";
                bodyContent = `
                    <div class="letter-body">
                        <p><strong>Date:</strong> ${today}</p>
                        <p><strong>To:</strong> The Faculty In-Charge,</p>
                        <p><strong>Subject:</strong> Application for Leave</p>
                        <br>
                        <p>Respected Sir/Madam,</p>
                        <p>I am <strong>${data.studentName}</strong> (Student ID: <strong>${data.studentId}</strong>). I would like to request leave starting from <strong>${data.startDate}</strong> for <strong>${data.days} days</strong>.</p>
                        <p><strong>Reason:</strong> ${data.reason}</p>
                        <br>
                        <p>My appeal has been reviewed and officially <strong>APPROVED</strong> by the faculty.</p>
                    </div>
                `;
            } else {
                title = "STUDENT OUTPASS TICKET";
                bodyContent = `
                    <div class="ticket-box">
                        <div class="row">
                            <span class="label">Student Name:</span>
                            <span class="value">${data.studentName}</span>
                        </div>
                        <div class="row">
                            <span class="label">Student ID:</span>
                            <span class="value">${data.studentId}</span>
                        </div>
                        <div class="row">
                            <span class="label">Valid Date:</span>
                            <span class="value">${data.startDate}</span>
                        </div>
                        <div class="row">
                            <span class="label">Reason:</span>
                            <span class="value">${data.reason}</span>
                        </div>
                        <div class="status-stamp">APPROVED</div>
                    </div>
                `;
            }

            const printWindow = window.open('', '', 'height=800,width=900');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${title} - ${uniqueId}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 40px; color: #000; max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; border-bottom: 3px double #333; padding-bottom: 20px; margin-bottom: 40px; }
                        .college-name { font-size: 28px; font-weight: bold; text-transform: uppercase; color: #1a237e; letter-spacing: 1px; margin: 0; }
                        .doc-title { font-size: 18px; font-weight: bold; text-decoration: underline; margin-top: 15px; }
                        .content { font-size: 18px; line-height: 1.8; margin-bottom: 50px; }
                        .ticket-box { border: 2px dashed #333; padding: 30px; background: #fdfdfd; }
                        .ticket-box .row { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                        .ticket-box .label { font-weight: bold; width: 150px; display: inline-block; }
                        .status-stamp { color: green; font-weight: bold; font-size: 24px; border: 3px solid green; padding: 10px 30px; display: inline-block; margin-top: 20px; transform: rotate(-5deg); opacity: 0.8; }
                        .footer { display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid #ccc; padding-top: 30px; }
                        .security-info p { margin: 5px 0; font-size: 14px; color: #555; font-family: sans-serif; }
                        .id-pill { background: #eee; padding: 5px 10px; border-radius: 4px; font-family: monospace; font-weight: bold; font-size: 16px; }
                        .signature { text-align: center; }
                        .signature p { margin-top: 40px; border-top: 1px solid #333; padding-top: 10px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1 class="college-name">Lendi Institute of Engineering and Technology</h1>
                        <div class="doc-title">${title}</div>
                    </div>
                    <div class="content">${bodyContent}</div>
                    <div class="footer">
                        <div class="security-info">
                            <p><strong>Security Check:</strong> Scan QR to verify.</p>
                            <p>Unique Ref ID: <span class="id-pill">${uniqueId}</span></p>
                            <div id="qrcode" style="margin-top: 15px;"></div>
                        </div>
                        <div class="signature"><p>Faculty Signature</p><small>(Authorized)</small></div>
                    </div>
                    <script>
                        window.onload = function() {
                            new QRCode(document.getElementById("qrcode"), { text: "${uniqueId}", width: 128, height: 128 });
                            setTimeout(() => { window.print(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }


        // -----------------------
        // ATTENDANCE LOGIC
        // -----------------------
        let currentLocation = null;

        function showAttendanceSection(sectionId) {
            document.getElementById('attendanceSelection').style.display = 'none';
            document.getElementById('postAttendanceSection').style.display = 'none';
            document.getElementById('dayWiseSection').style.display = 'none';
            document.getElementById('monthlySection').style.display = 'none';

            document.getElementById(sectionId).style.display = 'block';

            if (sectionId === 'dayWiseSection') {
                // Reset Date View
                document.getElementById('checkDateInput').valueAsDate = new Date();
                document.getElementById('dateResultBox').style.display = 'none';
            }
            if (sectionId === 'monthlySection') loadMonthlyAttendance();
        }

        function showAttendanceHome() {
            document.getElementById('attendanceSelection').style.display = 'block';
            document.getElementById('postAttendanceSection').style.display = 'none';
            document.getElementById('dayWiseSection').style.display = 'none';
            document.getElementById('monthlySection').style.display = 'none';

            // Reset Analyze UI
            document.getElementById('analyzeText').innerText = "Tap to Analyze";
            document.getElementById('analyzeIcon').className = "fas fa-search-location";
            document.querySelector('.analyze-btn-inner').style.background = "white";
            document.querySelector('.analyze-btn-inner').style.color = "#4facfe";
            document.getElementById('locationStatusBox').style.display = 'none';
        }

        function analyseLocation() {
            const text = document.getElementById("analyzeText");
            const icon = document.getElementById("analyzeIcon");
            const btnInner = document.querySelector('.analyze-btn-inner');
            const statusBox = document.getElementById("locationStatusBox");
            const statusText = document.getElementById("locationStatusText");
            const statusIcon = document.getElementById("statusIcon");
            const postBtn = document.getElementById("postAttendanceBtn");

            // Animation State
            text.innerText = "Scanning...";
            icon.className = "fas fa-satellite-dish fa-spin";
            btnInner.style.color = "#ff4757";

            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Success
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;

                        // Accuracy info
                        console.log("User Location:", userLat, userLng, "Accuracy:", position.coords.accuracy);

                        // Call Backend for Validation
                        fetch("/api/attendance/validate", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ latitude: userLat, longitude: userLng })
                        })
                            .then(res => {
                                if (!res.ok) return res.json().then(data => { throw new Error(data.message) });
                                return res.json();
                            })
                            .then(data => {
                                // Validated
                                currentLocation = { lat: userLat, lng: userLng };

                                setTimeout(() => {
                                    text.innerText = "Verified!";
                                    icon.className = "fas fa-check";
                                    icon.style.animation = "none";
                                    btnInner.style.background = "#2ecc71";
                                    btnInner.style.color = "white";

                                    statusBox.style.display = "block";
                                    statusBox.style.background = "#d4edda";
                                    statusText.innerText = data.message;
                                    statusIcon.className = "fas fa-check-circle";
                                    statusIcon.style.color = "#2ecc71";

                                    postBtn.disabled = false;
                                    postBtn.style.opacity = "1";
                                    postBtn.style.cursor = "pointer";
                                    postBtn.style.transform = "scale(1.05)";
                                }, 1500);
                            })
                            .catch(err => {
                                // OUT OF RANGE
                                setTimeout(() => {
                                    text.innerText = "Location Mismatch";
                                    icon.className = "fas fa-exclamation-triangle";
                                    btnInner.style.background = "#e74c3c";
                                    btnInner.style.color = "white";

                                    statusBox.style.display = "block";
                                    statusBox.style.background = "#f8d7da";
                                    statusText.innerHTML = err.message || "Location verification failed.";
                                    statusIcon.className = "fas fa-times-circle";
                                    statusIcon.style.color = "#e74c3c";
                                }, 1500);
                            });
                    },
                    (error) => {
                        // Error
                        text.innerText = "Failed";
                        icon.className = "fas fa-times";
                        btnInner.style.background = "#e74c3c";
                        btnInner.style.color = "white";

                        statusBox.style.display = "block";
                        statusBox.style.background = "#f8d7da";

                        let msg = "GPS Access Denied";
                        if (error.code === error.TIMEOUT) msg = "Location Timed Out";
                        if (error.code === error.POSITION_UNAVAILABLE) msg = "Location Unavailable";

                        statusText.innerText = msg;
                    },
                    options
                );
            } else {
                alert("Geolocation not supported");
            }
        }

        function postAttendance() {
            if (!currentLocation) return;

            const payload = {
                userId: user.userId,
                latitude: currentLocation.lat,
                longitude: currentLocation.lng
            };

            const btn = document.getElementById("postAttendanceBtn");
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Posting...`;

            fetch("/api/attendance/mark", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (!res.ok) {
                        // Try to read error message
                        return res.text().then(text => { throw new Error(text || res.statusText) });
                    }
                    return res.json();
                })
                .then(data => {
                    alert("Attendance Marked Successfully for Today!");
                    btn.innerHTML = `<i class="fas fa-check-double"></i> Marked`;
                    btn.disabled = true;
                    showAttendanceHome();
                })
                .catch(err => {
                    console.error(err);
                    // Extract clean message if possible (e.g., JSON error)
                    let msg = err.message;
                    try {
                        const json = JSON.parse(msg);
                        if (json.message) msg = json.message;
                        else if (json.error) msg = json.error;
                    } catch (e) { }

                    alert("Failed: " + msg);
                    btn.innerHTML = `<i class="fas fa-check-circle"></i> Post Attendance`;
                });
        }

        function loadDayWiseAttendance() {
            const tbody = document.getElementById("dayWiseTableBody");
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Loading...</td></tr>`;

            fetch(`/api/attendance/student/${user.userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No records found.</td></tr>`;
                        return;
                    }
                    tbody.innerHTML = data.map(r => `
                        <tr>
                            <td>${r.date}</td>
                            <td>${new Date(r.timestamp).toLocaleTimeString()}</td>
                            <td><span class="status-badge status-approved">${r.status}</span></td>
                        </tr>
                    `).join('');
                });
        }

        function checkDateAttendance() {
            const dateVal = document.getElementById('checkDateInput').value;
            if (!dateVal) {
                alert("Please select a date first.");
                return;
            }

            const resultBox = document.getElementById('dateResultBox');
            const resultStatus = document.getElementById('resultStatus');
            const resultDate = document.getElementById('resultDate');

            resultBox.style.display = 'block';
            resultStatus.innerHTML = `<i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: #4facfe;"></i>`;
            resultDate.innerText = dateVal;

            fetch(`/api/attendance/student/${user.userId}/date/${dateVal}`)
                .then(res => {
                    if (!res.ok) {
                        // If 404 or other error, likely absent or error
                        if (res.status === 404) return null; // Not found
                        throw new Error("Error fetching status");
                    }
                    return res.text();
                })
                .then(text => {
                    if (text && text.length > 0) {
                        try {
                            const data = JSON.parse(text);
                            // Verify status explicitly
                            if (data && data.status === 'PRESENT') {
                                resultStatus.innerHTML = `<span style="color: #2ecc71;"><i class="fas fa-check-circle"></i> PRESENT</span>`;
                            } else {
                                resultStatus.innerHTML = `<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> ABSENT</span>`;
                            }
                        } catch (e) {
                            // JSON parse failed?
                            console.error("JSON parse error", e);
                            resultStatus.innerHTML = `<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> ABSENT</span>`;
                        }
                    } else {
                        // Empty response -> Absent
                        resultStatus.innerHTML = `<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> ABSENT</span>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    resultStatus.innerHTML = `<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> ABSENT</span>`;
                });
        }

        function loadMonthlyAttendance() {
            fetch(`/api/attendance/student/${user.userId}/monthly`)
                .then(res => res.json())
                .then(percent => {
                    const val = Math.round(percent);
                    document.getElementById("monthlyPercentDisplay").innerText = val + "%";
                    // Update Circle Stroke
                    const circle = document.getElementById("circleProgress");
                    const circumference = 2 * Math.PI * 15.9155;
                    const offset = circumference - (val / 100) * circumference;
                    circle.style.strokeDasharray = `${(val / 100) * circumference} ${circumference}`;
                });
        }

        // -----------------------
        // CANTEEN LOGIC (ENHANCED & PERSISTENT)
        // -----------------------

        // Default Menu Data (Fallback)
        const defaultMenu = [
            { id: 1, name: "Meals", price: 80, icon: "ðŸ²", available: 50 },
            { id: 2, name: "Parota (2pcs)", price: 50, icon: "ðŸ«“", available: 50 },
            { id: 3, name: "Chapathi (2pcs)", price: 40, icon: "ðŸ¢", available: 50 },
            { id: 4, name: "Chicken Biryani", price: 150, icon: "ðŸ—", available: 50 },
            { id: 5, name: "Veg Biryani", price: 100, icon: "ðŸ¥—", available: 50 },
            { id: 6, name: "Fried Rice", price: 90, icon: "ðŸš", available: 50 },
            { id: 7, name: "Cold Coffee", price: 30, icon: "ðŸ¥¤", available: 100 }
        ];

        // GLOBAL VARIABLE: Initialize from LocalStorage or Default
        let foodMenu = JSON.parse(localStorage.getItem('canteen_inventory')) || defaultMenu;

        // Ensure initialized in storage if missing (so Admin sees data)
        if (!localStorage.getItem('canteen_inventory')) {
            localStorage.setItem('canteen_inventory', JSON.stringify(defaultMenu));
        }

        let cart = {}; // { itemId: quantity }

        function openFoodMenu() {
            document.getElementById('applySelection').style.display = 'none';
            document.getElementById('foodMenuContainer').style.display = 'block';

            // CRITICAL: Reload from storage every time we open the menu
            // This ensures we see updates made by the Admin immediately
            const storedMenu = localStorage.getItem('canteen_inventory');
            if (storedMenu) {
                try {
                    foodMenu = JSON.parse(storedMenu);
                } catch (e) {
                    console.error("Error parsing canteen inventory", e);
                }
            }
            cart = {}; // Reset cart on fresh open
            renderMenu();
        }

        function renderMenu() {
            const grid = document.getElementById('foodGrid');
            grid.innerHTML = foodMenu.map(item => {
                const qty = cart[item.id] || 0;
                // Check limit (Visual only for this demo since we don't have a backend to decrement global stock)
                const isSoldOut = item.available <= 0;

                let qtyControls = `
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                        <span class="qty-val">${qty}</span>
                        <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                    </div>`;

                if (isSoldOut) {
                    qtyControls = `<div style="color:red; font-weight:bold; margin-top:auto;">SOLD OUT</div>`;
                }

                return `
                <div class="food-card ${isSoldOut ? 'sold-out' : ''}">
                    <div class="food-img-frame">${item.icon}</div>
                    <div class="food-content">
                        <div class="food-title">${item.name}</div>
                        <div class="food-price">â‚¹${item.price} <small style="color:#999;font-weight:normal;">(${item.available} left)</small></div>
                        ${qtyControls}
                    </div>
                </div>`;
            }).join('');
            updateSummary();
        }

        function updateQty(id, delta) {
            // Find item to check limit
            const item = foodMenu.find(i => i.id === id);

            if (!cart[id]) cart[id] = 0;

            const newQty = cart[id] + delta;

            // Check limits
            if (newQty > item.available) {
                alert(`Sorry, only ${item.available} plates of ${item.name} available!`);
                return;
            }
            if (newQty < 0) return;

            cart[id] = newQty;
            renderMenu();
        }

        function updateSummary() {
            let total = 0;
            let count = 0;
            for (let item of foodMenu) {
                if (cart[item.id] > 0) {
                    total += item.price * cart[item.id];
                    count += cart[item.id];
                }
            }
            document.getElementById('orderTotal').innerText = total;
            document.getElementById('orderSummary').style.display = count > 0 ? 'flex' : 'none';
        }

        function placeOrder() {
            const items = foodMenu.filter(i => cart[i.id] > 0).map(i => ({ ...i, qty: cart[i.id] }));
            if (items.length === 0) return;

            // 1. Double check availability before finalizing
            for (let i of items) {
                if (i.qty > i.available) {
                    alert(`Error: ${i.name} stock has changed. Only ${i.available} left.`);
                    cart[i.id] = i.available;
                    renderMenu();
                    return;
                }
            }

            // 2. Decrement Stock & Persist
            items.forEach(orderItem => {
                const menuItem = foodMenu.find(m => m.id === orderItem.id);
                if (menuItem) {
                    menuItem.available -= orderItem.qty;
                }
            });
            localStorage.setItem('canteen_inventory', JSON.stringify(foodMenu));

            const total = document.getElementById('orderTotal').innerText;
            const itemsStr = items.map(i => `${i.name} (x${i.qty})`).join(", ");

            const payload = {
                studentId: user.userId,
                items: itemsStr,
                total: parseFloat(total)
            };

            fetch("/api/food/order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);

                    const orderId = data.orderId;
                    const uniqueId = `LENDI-${orderId}`;
                    const date = new Date().toLocaleDateString();
                    const time = new Date().toLocaleTimeString();

                    alert(`Reserved Successfully! Your Order ID is ${orderId}`);

                    // Update Local Inventory (Visual only)
                    items.forEach(orderItem => {
                        const menuItem = foodMenu.find(m => m.id === orderItem.id);
                        if (menuItem) menuItem.available -= orderItem.qty;
                    });
                    localStorage.setItem('canteen_inventory', JSON.stringify(foodMenu));


                    // Print Receipt
                    const itemsHtml = items.map(i => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dotted #ccc;">
                        <span>${i.name} (x${i.qty})</span>
                        <span>â‚¹${i.price * i.qty}</span>
                    </div>
                `).join('');

                    const printWindow = window.open('', '', 'height=600,width=500');
                    printWindow.document.write(`
                    <html>
                    <head>
                        <title>Food Token - ${orderId}</title>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
                        <style>
                            body { font-family: 'Courier New', monospace; padding: 20px; text-align: center; background: #fff8e1; }
                            .token { border: 2px dashed #bf360c; padding: 20px; background: white; border-radius: 10px; max-width: 400px; margin: 0 auto; }
                            .header { font-weight: bold; font-size: 1.5rem; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                            .big-number { font-size: 2.5rem; color: #bf360c; font-weight: bold; margin: 10px 0; }
                            .items { text-align: left; margin: 20px 0; font-size: 0.9rem; }
                            .total { font-size: 1.2rem; font-weight: bold; border-top: 2px solid #333; margin-top: 10px; padding-top: 5px; text-align: right; }
                            .qr-area { display: flex; justify-content: center; margin-top: 20px; }
                            .success-msg { color: green; font-weight: bold; margin-bottom: 15px; border: 1px solid green; padding: 5px; }
                        </style>
                    </head>
                    <body>
                        <div class="token">
                            <div class="header">LENDI CANTEEN<br><span style="font-size:1rem; font-weight:normal;">Pre-order Token</span></div>
                            <div class="success-msg">Successfully Reserved</div>
                            <div>Date: ${date} ${time}</div>
                            <div class="big-number">#${orderId}</div>
                            <div class="items">
                                ${itemsHtml}
                                <div class="total">Total: â‚¹${total}</div>
                            </div>
                            <div class="qr-area">
                                <div id="qrcode"></div>
                            </div>
                            <p style="font-size:0.8rem; margin-top:10px;">Please pay at counter or show this if paid online.</p>
                            <p style="font-size:0.7rem; color:#888;">Ref: ${uniqueId}</p>
                        </div>
                        <script>
                            new QRCode(document.getElementById("qrcode"), { text: "${uniqueId}", width: 100, height: 100 });
                            setTimeout(() => window.print(), 500);
                        <\/script>
                    </body>
                    </html>
                `);
                    printWindow.document.close();

                    // Refresh UI
                    cart = {};
                    renderMenu();
                    loadFoodOrders();
                    showSelection();

                })
                .catch(err => {
                    alert("Failed to place order: " + err.message);
                });
        }

        function loadFoodOrders() {
            fetch(`/api/food/history/${user.userId}`)
                .then(res => res.json())
                .then(orders => {
                    if (orders.length === 0) {
                        document.getElementById('foodTable').innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999;">No orders yet.</td></tr>`;
                        return;
                    }

                    const rows = orders.map(o => `
                    <tr>
                        <td><strong>${o.orderId}</strong></td>
                        <td>${o.items}</td>
                        <td>â‚¹${o.totalAmount}</td>
                        <td>${new Date(o.orderTime).toLocaleString()}</td>
                        <td><span class="status-badge status-approved">${o.status}</span></td>
                    </tr>
                `).join('');

                    document.getElementById('foodTable').innerHTML = rows;
                })
                .catch(err => console.error("Error loading food history:", err));
        }
        // Helper: Haversine Formula for Distance Calculation
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
    </script>
</body>

</html>